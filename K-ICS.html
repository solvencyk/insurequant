<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>InsureQuant — K-ICS 지급여력비율 변동 추이</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#ffffff; --card:#f8f9fa; --border:#e9ecef; --text:#212529; --muted:#6c757d; --primary:#0d6efd; --primary-hover:#0b5ed7;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR}
    header{position:sticky;top:0;padding:10px 16px;border-bottom:1px solid var(--border);background:#ffffff;z-index:1000}
    .brand{font-weight:700;margin-bottom:12px;cursor:pointer;color:var(--primary);text-decoration:none}
    .brand:hover{color:var(--primary-hover)}
    .tabs{display:flex;gap:4px;margin-bottom:0}
    .tab{padding:8px 16px;border:1px solid var(--border);border-radius:8px 8px 0 0;background:var(--card);color:var(--muted);text-decoration:none;font-size:14px;font-weight:500;transition:all 0.2s;}
    .tab:hover{background:var(--primary);color:white;border-color:var(--primary)}
    .tab.active{background:var(--primary);color:white;border-color:var(--primary)}
    .container{max-width:1320px;margin:0 auto;padding:16px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px}
    .panel h2{margin:0 0 16px 0;color:var(--text);font-size:20px;font-weight:600}
    .panel p{color:var(--muted);line-height:1.6;margin:0 0 12px 0}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:16px}
    .select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#ffffff;color:#212529}
    .chart-container{position:relative;height:500px;border:1px solid var(--border);border-radius:8px;background:#ffffff;padding:16px}
    .coming-soon{text-align:center;padding:60px 20px;color:var(--muted)}
    .coming-soon h3{font-size:24px;margin:0 0 12px 0;color:var(--text)}
    .coming-soon p{font-size:16px;margin:0}
    .table-container{margin-top:32px;}
    table{border-collapse:collapse;width:100%;}
    th, td{border:1px solid var(--border);padding:6px 8px;text-align:left;}
    th{background:var(--card);}
    th:nth-child(n+2), td:nth-child(n+2){text-align:right;} /* 항목명 제외한 모든 셀 오른쪽 정렬 */
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="brand">InsureQuant <span class="hint" style="color:var(--muted);font-weight:400">K-ICS 지급여력비율 변동 추이</span></a>
    <div class="tabs">
      <a href="K-ICS.html" class="tab active">K-ICS</a>
      <a href="IFRS17.html" class="tab">IFRS17</a>
      <a href="공시보고서.html" class="tab">공시/보고서</a>
    </div>
  </header>
  <div class="container">
    <div class="panel">
      <h2>원보험사별 K-ICS 지급여력비율 변동 추이</h2>
      <p>보험회사들의 K-ICS 지급여력비율 변화를 시계열로 분석하여 안정성 추이를 파악할 수 있습니다.</p>
    </div>
    <div class="panel">
      <div class="controls">
        <div>
          <label>보험사 선택: 
            <select id="company" class="select">
              <option value="">보험사 선택</option>
              <option value="한화생명">한화생명</option>
              <option value="교보생명보험">교보생명보험</option>
              <option value="흥국생명보험">흥국생명보험</option>
              <option value="라이나생명보험">라이나생명보험</option>
              <option value="DB생명보험">DB생명보험</option>
              <option value="에이비엘생명보험">에이비엘생명보험</option>
              <option value="케이디비생명보험">케이디비생명보험</option>
              <option value="푸본현대생명보험">푸본현대생명보험</option>
              <option value="아이엠라이프생명보험">아이엠라이프생명보험</option>
              <option value="처브라이프생명보험">처브라이프생명보험</option>
              <option value="비엔피파리바카디프생명보험">비엔피파리바카디프생명보험</option>
              <option value="DB손해보험">DB손해보험</option>
              <option value="삼성화재해상보험">삼성화재해상보험</option>
              <option value="현대해상">현대해상</option>
              <option value="KB손해보험">KB손해보험</option>
              <option value="메리츠화재해상보험">메리츠화재해상보험</option>
              <option value="한화손해보험">한화손해보험</option>
              <option value="롯데손해보험">롯데손해보험</option>
              <option value="흥국화재">흥국화재</option>
              <option value="NH농협손해보험">NH농협손해보험</option>
              <option value="하나손해보험">하나손해보험</option>
              <option value="악사손해보험">악사손해보험</option>
              <option value="신한이지손해보험">신한이지손해보험</option>
            </select>
          </label>
        </div>
        <div>
          <label>기간: 
            <select id="period" class="select">
              <option value="">기간 선택</option>
              <option value="quarter">분기</option>
              <option value="year">연도</option>
            </select>
          </label>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="chart" style="display:none;"></canvas>
      </div>
      <div class="table-container" id="table-container"></div>
    </div>
  </div>
  <script>
    const jsonPath = 'kics_disclosure.json';
    let allData = [];
    let chart = null;

    // 공시분기 최신 N개 추출
    function getRecentQuarters(data, nQuarter) {
      const allQuarters = Array.from(new Set(data.map(row => row['공시분기']))).sort((a, b) => {
        const parse = s => {
          const m = s.match(/^(\d{4})\.(\d)Q$/);
          return m ? [parseInt(m[1]), parseInt(m[2])] : [0,0];
        };
        const [ay, aq] = parse(a), [by, bq] = parse(b);
        if (ay !== by) return by - ay;
        return bq - aq;
      });
      return allQuarters.slice(0, nQuarter);
    }

    // 보험사/기간 모두 지정되어야만 테이블 출력
    function canShowTable() {
      const company = document.getElementById('company').value;
      const period = document.getElementById('period').value;
      return company && period;
    }

    // 숫자 포맷팅 함수 (천 단위 쉼표, 소수점 첫째 자리)
    function formatNumber(value) {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      
      // 문자열에서 숫자 추출 (쉼표 제거 후 파싱)
      const strValue = String(value).replace(/,/g, '').trim();
      const numValue = parseFloat(strValue);
      
      if (isNaN(numValue)) {
        return value; // 숫자가 아니면 원본 반환
      }
      
      // 소수점이 있는지 확인 (정수인지 확인)
      const hasDecimal = numValue % 1 !== 0;
      
      if (hasDecimal) {
        // 소수점이 있는 경우 첫째 자리까지만 표시
        return numValue.toLocaleString('ko-KR', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 1
        });
      }
      
      // 정수인 경우 천 단위 쉼표만 추가
      return numValue.toLocaleString('ko-KR');
    }

    // 피벗 테이블 렌더링 (행: 항목명, 열: 공시분기)
    function renderPivotTable(data, quarters) {
      if (!Array.isArray(data) || !data.length) {
        document.getElementById('table-container').innerHTML = '<p>데이터가 없습니다.</p>';
        return;
      }
      // 항목명 목록 추출 (행)
      const itemNames = Array.from(new Set(data.map(row => row['항목명'])));
      // 테이블 헤더: [항목명, ...공시분기(역순)]
      let table = '<table><thead><tr><th>항목명</th>';
      quarters.forEach(q => table += `<th>${q}</th>`);
      table += '</tr></thead><tbody>';
      itemNames.forEach(item => {
        table += `<tr><td>${item}</td>`;
        quarters.forEach(q => {
          const found = data.find(row => row['항목명'] === item && row['공시분기'] === q);
          if (found && found['값'] !== null && found['값'] !== undefined && found['값'] !== '') {
            table += `<td>${formatNumber(found['값'])}</td>`;
          } else {
            table += '<td></td>';
          }
        });
        table += '</tr>';
      });
      table += '</tbody></table>';
      document.getElementById('table-container').innerHTML = table;
    }

    // 연말 분기 추출 (최신 분기 + 1년 전 연말 + 2년 전 연말)
    function getYearEndQuarters(data) {
      const allQuarters = Array.from(new Set(data.map(row => row['공시분기']))).sort((a, b) => {
        const parse = s => {
          const m = s.match(/^(\d{4})\.(\d)Q$/);
          return m ? [parseInt(m[1]), parseInt(m[2])] : [0,0];
        };
        const [ay, aq] = parse(a), [by, bq] = parse(b);
        if (ay !== by) return by - ay;
        return bq - aq;
      });
      
      if (allQuarters.length === 0) return [];
      
      // 최신 분기
      const latest = allQuarters[0];
      const [latestYear, latestQuarter] = (() => {
        const m = latest.match(/^(\d{4})\.(\d)Q$/);
        return m ? [parseInt(m[1]), parseInt(m[2])] : [0, 0];
      })();
      
      const selectedQuarters = [latest];
      
      // 1년 전 연말 (4Q)
      const year1Ago = `${latestYear - 1}.4Q`;
      if (allQuarters.includes(year1Ago)) {
        selectedQuarters.push(year1Ago);
      }
      
      // 2년 전 연말 (4Q)
      const year2Ago = `${latestYear - 2}.4Q`;
      if (allQuarters.includes(year2Ago)) {
        selectedQuarters.push(year2Ago);
      }
      
      // 최신순으로 정렬 (최신 → 과거)
      return selectedQuarters.sort((a, b) => {
        const parse = s => {
          const m = s.match(/^(\d{4})\.(\d)Q$/);
          return m ? [parseInt(m[1]), parseInt(m[2])] : [0,0];
        };
        const [ay, aq] = parse(a), [by, bq] = parse(b);
        if (ay !== by) return by - ay;
        return bq - aq;
      });
    }

    function getFilteredData() {
      let filtered = allData;
      // 보험사 필터
      const company = document.getElementById('company').value;
      if (company) filtered = filtered.filter(row => row['원수사명'] === company);
      
      // 기간 필터
      const period = document.getElementById('period').value;
      let selectedQuarters = [];
      
      if (period === 'quarter') {
        // 분기: 직전 4개 분기
        selectedQuarters = getRecentQuarters(filtered, 4);
      } else if (period === 'year') {
        // 연도: 최신 분기 + 1년 전 연말 + 2년 전 연말
        selectedQuarters = getYearEndQuarters(filtered);
      }
      
      filtered = filtered.filter(row => selectedQuarters.includes(row['공시분기']));
      return {filtered, recentQuarters: selectedQuarters};
    }

    function updateTable() {
      if (!canShowTable()) {
        document.getElementById('table-container').innerHTML = '';
        return;
      }
      const {filtered, recentQuarters} = getFilteredData();
      renderPivotTable(filtered, recentQuarters);
      updateChart(filtered, recentQuarters);
    }

    function updateChart(data, quarters) {
      if (!canShowTable()) {
        // 보험사와 기간이 선택되지 않았으면 차트 숨김
        if (chart) {
          chart.destroy();
          chart = null;
        }
        const ctx = document.getElementById('chart');
        if (ctx) {
          ctx.style.display = 'none';
        }
        return;
      }
      
      const ctx = document.getElementById('chart');
      ctx.style.display = 'block';
      const chartCtx = ctx.getContext('2d');
      
      // '다. 지급여력비율' 데이터 추출
      const solvencyRatioData = quarters.map(q => {
        const row = data.find(r => r['항목명'] === '다. 지급여력비율 : 가 ÷ 나 × 100' && r['공시분기'] === q);
        if (!row) return null;
        const value = parseFloat(String(row['값']).replace(/,/g, '')) || 0;
        return value;
      });

      // '기본자본비율' 데이터 추출
      const basicCapitalRatioData = quarters.map(q => {
        // 먼저 '기본자본비율' 항목명으로 직접 검색
        let row = data.find(r => r['항목명'] === '기본자본비율' && r['공시분기'] === q);
        
        if (row) {
          const value = parseFloat(String(row['값']).replace(/,/g, '')) || 0;
          return value;
        }
        
        // '기본자본'과 '나. 지급여력기준금액'으로 계산 (기본자본 / 지급여력기준금액 * 100)
        const basicCapital = data.find(r => 
          (r['항목명'] === '기본자본' || r['항목명'] === '2. 기본자본') 
          && r['공시분기'] === q
        );
        const requiredCapital = data.find(r => 
          (r['항목명'] === '나. 지급여력기준금액 (Ⅰ-Ⅱ+Ⅲ)' || 
           r['항목명'] === '나. 지급여력기준금액' ||
           r['항목명'] === '지급여력기준금액') 
          && r['공시분기'] === q
        );
        
        if (basicCapital && requiredCapital) {
          const capital = parseFloat(String(basicCapital['값']).replace(/,/g, '')) || 0;
          const required = parseFloat(String(requiredCapital['값']).replace(/,/g, '')) || 0;
          return required > 0 ? (capital / required * 100) : null;
        }
        
        return null;
      });

      // 기존 차트가 있으면 제거
      if (chart) {
        chart.destroy();
      }

      // 차트 생성
      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: quarters,
          datasets: [
            {
              label: '다. 지급여력비율',
              data: solvencyRatioData,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.1)',
              tension: 0.1,
              fill: true
            },
            {
              label: '기본자본비율',
              data: basicCapitalRatioData,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.1)',
              tension: 0.1,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '지급여력비율 및 기본자본비율 시계열 추이'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y.toFixed(2) + '%';
                  } else {
                    label += '데이터 없음';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: '비율 (%)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(1) + '%';
                }
              }
            },
            x: {
              title: {
                display: true,
                text: '공시분기'
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }

    fetch(jsonPath)
      .then(response => response.json())
      .then(data => {
        allData = data;
        updateTable();
        document.getElementById('company').addEventListener('change', updateTable);
        document.getElementById('period').addEventListener('change', updateTable);
      })
      .catch(e => {
        document.getElementById('table-container').innerHTML = `<p>JSON 파일을 불러오는 중 오류 발생: ${e}</p>`;
      });
  </script>
</body>
</html>
