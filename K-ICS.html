<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>InsureQuant — K-ICS 지급여력비율 변동 추이</title>
  <style>
    :root{--bg:#ffffff; --card:#f8f9fa; --border:#e9ecef; --text:#212529; --muted:#6c757d; --primary:#0d6efd; --primary-hover:#0b5ed7;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR}
    header{position:sticky;top:0;padding:10px 16px;border-bottom:1px solid var(--border);background:#ffffff;z-index:1000}
    .brand{font-weight:700;margin-bottom:12px;cursor:pointer;color:var(--primary);text-decoration:none}
    .brand:hover{color:var(--primary-hover)}
    .tabs{display:flex;gap:4px;margin-bottom:0}
    .tab{padding:8px 16px;border:1px solid var(--border);border-radius:8px 8px 0 0;background:var(--card);color:var(--muted);text-decoration:none;font-size:14px;font-weight:500;transition:all 0.2s;}
    .tab:hover{background:var(--primary);color:white;border-color:var(--primary)}
    .tab.active{background:var(--primary);color:white;border-color:var(--primary)}
    .container{max-width:1320px;margin:0 auto;padding:16px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px}
    .panel h2{margin:0 0 16px 0;color:var(--text);font-size:20px;font-weight:600}
    .panel p{color:var(--muted);line-height:1.6;margin:0 0 12px 0}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:16px}
    .select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#ffffff;color:#212529}
    .chart-container{position:relative;height:500px;border:1px solid var(--border);border-radius:8px;background:#ffffff;padding:16px}
    .coming-soon{text-align:center;padding:60px 20px;color:var(--muted)}
    .coming-soon h3{font-size:24px;margin:0 0 12px 0;color:var(--text)}
    .coming-soon p{font-size:16px;margin:0}
    .table-container{margin-top:32px;}
    table{border-collapse:collapse;width:100%;}
    th, td{border:1px solid var(--border);padding:6px 8px;text-align:left;}
    th{background:var(--card);}
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="brand">InsureQuant <span class="hint" style="color:var(--muted);font-weight:400">K-ICS 지급여력비율 변동 추이</span></a>
    <div class="tabs">
      <a href="K-ICS.html" class="tab active">K-ICS</a>
      <a href="IFRS17.html" class="tab">IFRS17</a>
      <a href="공시보고서.html" class="tab">공시/보고서</a>
    </div>
  </header>
  <div class="container">
    <div class="panel">
      <h2>원보험사별 K-ICS 지급여력비율 변동 추이</h2>
      <p>보험회사들의 K-ICS 지급여력비율 변화를 시계열로 분석하여 안정성 추이를 파악할 수 있습니다.</p>
    </div>
    <div class="panel">
      <div class="controls">
        <div>
          <label>보험사 선택: 
            <select id="company" class="select">
              <option value="">보험사 선택</option>
              <option value="한화생명">한화생명</option>
              <option value="교보생명보험">교보생명보험</option>
              <option value="흥국생명보험">흥국생명보험</option>
              <option value="라이나생명보험">라이나생명보험</option>
              <option value="DB생명보험">DB생명보험</option>
              <option value="에이비엘생명보험">에이비엘생명보험</option>
              <option value="케이디비생명보험">케이디비생명보험</option>
              <option value="푸본현대생명보험">푸본현대생명보험</option>
              <option value="아이엠라이프생명보험">아이엠라이프생명보험</option>
              <option value="처브라이프생명보험">처브라이프생명보험</option>
              <option value="비엔피파리바카디프생명보험">비엔피파리바카디프생명보험</option>
              <option value="DB손해보험">DB손해보험</option>
              <option value="삼성화재해상보험">삼성화재해상보험</option>
              <option value="현대해상">현대해상</option>
              <option value="KB손해보험">KB손해보험</option>
              <option value="메리츠화재해상보험">메리츠화재해상보험</option>
              <option value="한화손해보험">한화손해보험</option>
              <option value="롯데손해보험">롯데손해보험</option>
              <option value="흥국화재">흥국화재</option>
              <option value="NH농협손해보험">NH농협손해보험</option>
              <option value="하나손해보험">하나손해보험</option>
              <option value="악사손해보험">악사손해보험</option>
              <option value="신한이지손해보험">신한이지손해보험</option>
            </select>
          </label>
        </div>
        <div>
          <label>기간: 
            <select id="period" class="select">
              <option value="">기간 선택</option>
              <option value="1Y">최근 1년</option>
              <option value="2Y">최근 2년</option>
              <option value="3Y">최근 3년</option>
              <option value="5Y">최근 5년</option>
            </select>
          </label>
        </div>
      </div>
      <div class="chart-container">
        <div class="coming-soon">
          <h3>📊 차트 준비 중</h3>
          <p>K-ICS 지급여력비율 변동 추이 차트가 곧 추가될 예정입니다.</p>
          <p>보험회사별 시계열 데이터를 시각화하여 안정성 추이를 분석할 수 있습니다.</p>
        </div>
      </div>
      <div class="table-container" id="table-container"></div>
    </div>
  </div>
  <script>
    const jsonPath = 'kics_disclosure.json';
    let allData = [];

    // 공시분기 최신 N개 추출
    function getRecentQuarters(data, nQuarter) {
      const allQuarters = Array.from(new Set(data.map(row => row['공시분기']))).sort((a, b) => {
        const parse = s => {
          const m = s.match(/^(\d{4})\.(\d)Q$/);
          return m ? [parseInt(m[1]), parseInt(m[2])] : [0,0];
        };
        const [ay, aq] = parse(a), [by, bq] = parse(b);
        if (ay[0] != by[0]) return by[0] - ay[0];
        return by[1] - aq[1];
      });
      return allQuarters.slice(0, nQuarter);
    }

    // 보험사/기간 모두 지정되어야만 테이블 출력
    function canShowTable() {
      const company = document.getElementById('company').value;
      const period = document.getElementById('period').value;
      return company && period;
    }

    // 피벗 테이블 렌더링 (행: 항목명, 열: 공시분기)
    function renderPivotTable(data, quarters) {
      if (!Array.isArray(data) || !data.length) {
        document.getElementById('table-container').innerHTML = '<p>데이터가 없습니다.</p>';
        return;
      }
      // 항목명 목록 추출 (행)
      const itemNames = Array.from(new Set(data.map(row => row['항목명'])));
      // 테이블 헤더: [항목명, ...공시분기(역순)]
      let table = '<table><thead><tr><th>항목명</th>';
      quarters.forEach(q => table += `<th>${q}</th>`);
      table += '</tr></thead><tbody>';
      itemNames.forEach(item => {
        table += `<tr><td>${item}</td>`;
        quarters.forEach(q => {
          const found = data.find(row => row['항목명'] === item && row['공시분기'] === q);
          table += `<td>${found ? (found['값'] ?? '') : ''}</td>`;
        });
        table += '</tr>';
      });
      table += '</tbody></table>';
      document.getElementById('table-container').innerHTML = table;
    }

    function getFilteredData() {
      let filtered = allData;
      // 보험사 필터
      const company = document.getElementById('company').value;
      if (company) filtered = filtered.filter(row => row['원수사명'] === company);
      // 기간 필터 (최신 N개 분기만 남김)
      const period = document.getElementById('period').value;
      let nQuarter = 4;
      if (period === '2Y') nQuarter = 8;
      if (period === '3Y') nQuarter = 12;
      if (period === '5Y') nQuarter = 20;
      const recentQuarters = getRecentQuarters(filtered, nQuarter);
      filtered = filtered.filter(row => recentQuarters.includes(row['공시분기']));
      return {filtered, recentQuarters};
    }

    function updateTable() {
      if (!canShowTable()) {
        document.getElementById('table-container').innerHTML = '';
        return;
      }
      const {filtered, recentQuarters} = getFilteredData();
      renderPivotTable(filtered, recentQuarters);
    }

    fetch(jsonPath)
      .then(response => response.json())
      .then(data => {
        allData = data;
        updateTable();
        document.getElementById('company').addEventListener('change', updateTable);
        document.getElementById('period').addEventListener('change', updateTable);
      })
      .catch(e => {
        document.getElementById('table-container').innerHTML = `<p>JSON 파일을 불러오는 중 오류 발생: ${e}</p>`;
      });
  </script>
</body>
</html>
