<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>InsureQuant — K-ICS Market Map (Balanced Treemap)</title>
  <style>
    :root{--bg:#ffffff; --card:#f8f9fa; --border:#e9ecef; --text:#212529; --muted:#6c757d; --primary:#0d6efd; --primary-hover:#0b5ed7;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR}
    header{position:sticky;top:0;padding:10px 16px;border-bottom:1px solid var(--border);background:#ffffff;z-index:1000}
    .brand{font-weight:700;margin-bottom:12px;cursor:pointer;color:var(--primary);text-decoration:none}
    .brand:hover{color:var(--primary-hover)}
    .tabs{display:flex;gap:4px;margin-bottom:0}
    .tab{padding:8px 16px;border:1px solid var(--border);border-radius:8px 8px 0 0;background:var(--card);color:var(--muted);text-decoration:none;font-size:14px;font-weight:500;transition:all 0.2s;cursor:pointer}
    .tab:hover{background:var(--primary);color:white;border-color:var(--primary)}
    .tab.active{background:var(--primary);color:white;border-color:var(--primary)}
    .container{max-width:1320px;margin:0 auto;padding:16px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:8px}
    .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .swatch{width:110px;height:10px;background:linear-gradient(90deg,#7f1d1d,#ef4444,#fca5a5,#34d399,#16a34a,#14532d);border-radius:6px}
    .select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#ffffff;color:#212529}
    .toggle-switch{position:relative;display:inline-block;width:60px;height:30px}
    .toggle-input{opacity:0;width:0;height:0}
    .toggle-label{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px}
    .toggle-label:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
    .toggle-input:checked + .toggle-label{background-color:var(--primary)}
    .toggle-input:checked + .toggle-label:before{transform:translateX(30px)}
    .toggle-slider{display:none}
    #map{position:relative;height:76vh;min-height:560px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    .group{position:absolute;border:1px solid rgba(0,0,0,.12);border-radius:10px;overflow:hidden;background:rgba(0,0,0,.02)}
    .group-title{position:absolute;left:6px;top:6px;font-size:12px;color:var(--muted);background:rgba(255,255,255,.8);padding:2px 6px;border-radius:6px;z-index:2}
    .cell{position:absolute;border:1px solid rgba(0,0,0,.08);border-radius:8px;padding:6px;display:flex;flex-direction:column;justify-content:space-between;overflow:hidden}
    .name{font-weight:700;font-size:12px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ratio{font-size:15px;font-weight:700}
    .meta{font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <a href="main.html" class="brand">InsureQuant <span class="hint" style="color:var(--muted);font-weight:400">K-ICS Market Map (Balanced Treemap)</span></a>
    <div class="tabs">
      <a href="K-ICS.html" class="tab">K-ICS</a>
      <a href="IFRS17.html" class="tab">IFRS17</a>
      <a href="공시보고서.html" class="tab">공시/보고서</a>
    </div>
  </header>
  <div class="container">
    <div class="panel">
      <div class="controls">
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <div>
            <label>업권: 
              <select id="sector" class="select">
                <option value="ALL">전체</option>
                <option value="Life">생명보험</option>
                <option value="Non-Life">손해보험</option>
              </select>
            </label>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <span style="font-size:14px;color:var(--text)">K-ICS 지급여력비율</span>
            <div class="toggle-switch">
              <input type="checkbox" id="ratioToggle" class="toggle-input">
              <label for="ratioToggle" class="toggle-label">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <span style="font-size:14px;color:var(--text)">기본자본비율</span>
          </div>
        </div>
        <div class="legend">
          <div id="legendText">색상: K-ICS 비율</div>
          <div class="swatch"></div>
          <div>크기: 지급여력기준금액</div>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let GROUPED = {};
    
    // 기본 데이터 로드
    function loadData() {
      loadDefaultData();
    }
    
    // 기본 데이터로 초기화
    function loadDefaultData() {
      GROUPED = {"Life": [{"company": "한화생명", "sector": "Life", "ratio": 154.1, "required": 136764.0}, {"company": "교보생명보험", "sector": "Life", "ratio": 145.84, "required": 89733.0}, {"company": "흥국생명보험", "sector": "Life", "ratio": 153.2, "required": 23819.0}, {"company": "라이나생명보험", "sector": "Life", "ratio": 348.16, "required": 21483.0}, {"company": "DB생명보험", "sector": "Life", "ratio": 150.51, "required": 15256.0}, {"company": "에이비엘생명보험", "sector": "Life", "ratio": 104.63, "required": 15227.0}, {"company": "케이디비생명보험", "sector": "Life", "ratio": 40.60161856772027, "required": 13098.0}, {"company": "푸본현대생명보험", "sector": "Life", "ratio": -24.0, "required": 13092.0}, {"company": "아이엠라이프생명보험", "sector": "Life", "ratio": 90.5, "required": 5712.0}, {"company": "처브라이프생명보험", "sector": "Life", "ratio": 133.5648148148148, "required": 1296.0}, {"company": "비엔피파리바카디프생명보험", "sector": "Life", "ratio": 304.61, "required": 695.0}], "Non-Life": [{"company": "DB손해보험", "sector": "Non-Life", "ratio": 204.66, "required": 97883.0}, {"company": "삼성화재해상보험", "sector": "Non-Life", "ratio": 266.61, "required": 93446.0}, {"company": "현대해상", "sector": "Non-Life", "ratio": 159.4, "required": 82186.0}, {"company": "KB손해보험", "sector": "Non-Life", "ratio": 182.16, "required": 63515.0}, {"company": "메리츠화재해상보험", "sector": "Non-Life", "ratio": 238.92, "required": 55434.0}, {"company": "한화손해보험", "sector": "Non-Life", "ratio": 182.5, "required": 33013.0}, {"company": "롯데손해보험", "sector": "Non-Life", "ratio": 101.6, "required": 23518.0}, {"company": "흥국화재", "sector": "Non-Life", "ratio": 174.03, "required": 18008.0}, {"company": "NH농협손해보험", "sector": "Non-Life", "ratio": 129.55, "required": 15676.0}, {"company": "하나손해보험", "sector": "Non-Life", "ratio": 150.14, "required": 3312.0}, {"company": "악사손해보험", "sector": "Non-Life", "ratio": 217.6, "required": 2401.0}, {"company": "신한이지손해보험", "sector": "Non-Life", "ratio": 3.406952965235174, "required": 489.0}]};
      render(sel.value);
    }
    
    

    function colorForRatio(r, ratioType = 'kics'){
      const ratio = Number.isFinite(r) ? r : 0;
      
      if (ratioType === 'basicCapital') {
        // 기본자본비율: 50% 기준
        if (ratio >= 50) {
          const t = Math.min(1, (ratio - 50)/50); // 50%에서 100%까지
          const saturation = 70 + 30*t; // 70%에서 100%까지
          const lightness = 50 - 20*t; // 50%에서 30%까지
          return `hsl(142, ${saturation}%, ${lightness}%)`;
        } else {
          const t = Math.min(1, (50 - ratio)/50); // 0%에서 50%까지
          const saturation = 70 + 30*t; // 70%에서 100%까지
          const lightness = 50 - 20*t; // 50%에서 30%까지
          return `hsl(0, ${saturation}%, ${lightness}%)`;
        }
      } else {
        // K-ICS 지급여력비율: 150% 기준
        if (ratio >= 150) {
          const t = Math.min(1, (ratio - 150)/100);
          const light = 44 - 22*t;
          return `hsl(142, 70%, ${light}%)`;
        } else {
          const t = Math.min(1, (150 - ratio)/100);
          const light = 50 - 26*t;
          return `hsl(0, 75%, ${light}%)`;
        }
      }
    }

    // Balanced binary partition (RecSplit) treemap
    function recsplit(items, rect) {
      // items: array of {value, data} (values unscaled; we'll scale by area)
      const sum = items.reduce((a,b)=>a+b.value,0) || 1;
      function split(list, x, y, w, h) {
        if (!list.length) return [];
        if (list.length === 1) return [{x, y, w, h, item:list[0]}];
        // sort desc
        list = list.slice().sort((a,b)=>b.value-a.value);
        const target = list.reduce((a,b)=>a+b.value,0) / 2;
        let acc = 0, idx = 0;
        while (idx < list.length && acc + list[idx].value <= target) {
          acc += list[idx].value; idx++;
        }
        if (idx === 0) idx = 1;
        const left = list.slice(0, idx);
        const right = list.slice(idx);
        const total = left.reduce((a,b)=>a+b.value,0) + right.reduce((a,b)=>a+b.value,0);
        const leftRatio = left.reduce((a,b)=>a+b.value,0) / total;
        // split along longer side to promote squareness
        if (w >= h) {
          const lw = w * leftRatio;
          return split(left, x, y, lw, h).concat(split(right, x+lw, y, w-lw, h));
        } else {
          const lh = h * leftRatio;
          return split(left, x, y, w, lh).concat(split(right, x, y+lh, w, h-lh));
        }
      }
      return split(items, rect.x, rect.y, rect.w, rect.h);
    }

    function layoutGroups(allData, rect, filterSector) {
      const sectors = Object.keys(allData).filter(s => s && s!=="Unknown");
      const groups = [];
      for (const s of sectors) {
        if (filterSector !== "ALL" && s !== filterSector) continue;
        const rows = allData[s];
        const sum = rows.reduce((a,b)=>a+b.required,0);
        if (sum>0) groups.push({ key:s, sum, rows });
      }
      const grand = groups.reduce((a,b)=>a+b.sum,0) || 1;
      const gItems = groups
        .map(g => ({ value: g.sum/grand, data: g }))
        .sort((a,b)=>b.value-a.value);

      const gRects = recsplit(gItems, rect);
      const out = [];

      for (const gr of gRects) {
        const gData = gr.item.data;
        out.push({ type:"group", sector: gData.key, x: gr.x, y: gr.y, w: gr.w, h: gr.h });

        // Inner recsplit for companies
        const padOuter = 6, titleH = 22, padInner = 6;
        const gx = gr.x + padOuter;
        const gy = gr.y + padOuter + titleH;
        const gw = Math.max(0, gr.w - padOuter*2);
        const gh = Math.max(0, gr.h - padOuter*2 - titleH);

        const items = gData.rows.map(d => ({ value: d.required, data: d }));

        const cells = recsplit(items, {x:gx+padInner, y:gy+padInner, w:Math.max(0,gw-2*padInner), h:Math.max(0,gh-2*padInner)});

        const MIN_W = 64, MIN_H = 48;
        for (const c of cells) {
          const w = Math.max(MIN_W, c.w-2);
          const h = Math.max(MIN_H, c.h-2);
          out.push({
            type:"cell",
            x: c.x, y: c.y, w: w, h: h,
            data: c.item.data
          });
        }
      }
      return out;
    }

    function render(sector) {
      const el = document.getElementById("map");
      const W = el.clientWidth, H = el.clientHeight;
      el.innerHTML = "";
      const rects = layoutGroups(GROUPED, {x:0,y:0,w:W,h:H}, sector);

      // 현재 토글 스위치 상태 확인
      const ratioType = document.getElementById('ratioToggle').checked ? 'basicCapital' : 'kics';
      
      // 범례 텍스트 업데이트
      const legendText = document.getElementById("legendText");
      legendText.textContent = ratioType === 'basicCapital' ? '색상: 기본자본비율' : '색상: K-ICS 비율';

      for (const r of rects) {
        if (r.type === "group") {
          const g = document.createElement("div");
          g.className = "group";
          g.style.left = r.x + "px";
          g.style.top = r.y + "px";
          g.style.width = r.w + "px";
          g.style.height = r.h + "px";
          const title = document.createElement("div");
          title.className = "group-title";
          title.textContent = r.sector === "Life" ? "생명보험" : "손해보험";
          g.appendChild(title);
          el.appendChild(g);
        } else if (r.type === "cell") {
          const d = r.data;
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.style.left = r.x + "px";
          cell.style.top = r.y + "px";
          cell.style.width = r.w + "px";
          cell.style.height = r.h + "px";
          
          // 선택된 비율 타입에 따라 색상 계산
          let displayRatio, displayValue;
          if (ratioType === 'basicCapital') {
            // 항목번호 28번의 기본자본비율만 사용
            displayValue = d.basicCapitalRatio || 0;
            displayRatio = displayValue;
            console.log(`${d.company} 기본자본비율 (항목번호 28): ${displayValue.toFixed(2)}%`);
            cell.style.background = colorForRatio(displayValue, 'basicCapital');
            cell.title = `${d.company} — 기본자본비율 ${displayValue.toFixed(1)}%, 기준금액 ${Math.round(d.required).toLocaleString()}`;
          } else {
            displayValue = d.ratio;
            displayRatio = d.ratio;
            cell.style.background = colorForRatio(d.ratio, 'kics');
            cell.title = `${d.company} — K-ICS 비율 ${(d.ratio??0).toFixed(1)}%, 기준금액 ${Math.round(d.required).toLocaleString()}`;
          }

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = d.company;

          const ratio = document.createElement("div");
          ratio.className = "ratio";
          ratio.textContent = (Number.isFinite(displayRatio)? displayRatio.toFixed(1):"-") + "%";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = "기준 " + Math.round(d.required).toLocaleString();

          cell.appendChild(name);
          cell.appendChild(ratio);
          cell.appendChild(meta);
          el.appendChild(cell);
        }
      }
    }

    const sel = document.getElementById("sector");
    function redraw() { render(sel.value); }
    window.addEventListener("resize", redraw);
    sel.addEventListener("change", redraw);
    
    // 토글 스위치 변경 이벤트 추가
    document.getElementById('ratioToggle').addEventListener("change", redraw);
    
    // 페이지 로드 시 CSV 데이터 자동 로드
    loadData();
  </script>
</body>
</html>
